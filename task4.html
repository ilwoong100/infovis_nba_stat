<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA ìƒëŒ€ ë¼ì¸ì—… ê¸°ë°˜ ìµœì  ë¼ì¸ì—… ì¶”ì²œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="data/nba_24_25.js"></script> 
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .main-content {
            display: flex;
            gap: 30px;
        }

        .left-panel {
            flex: 1;
            min-width: 400px;
        }

        .right-panel {
            flex: 1;
            min-width: 600px;
        }

        .opponent-setup {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .opponent-setup h3 {
            margin: 0 0 15px 0;
            color: #856404;
            text-align: center;
        }

        .team-selection {
            margin-bottom: 15px;
        }

        .team-selection label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .team-selection select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }

        .position-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .position-group {
            margin-bottom: 10px;
        }

        .position-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .position-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .position-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            margin-right: 5px;
        }

        .pos-PG { background-color: #FF6B6B; }
        .pos-SG { background-color: #4ECDC4; }
        .pos-SF { background-color: #45B7D1; }
        .pos-PF { background-color: #96CEB4; }
        .pos-C { background-color: #FFEAA7; color: #333; }

        .analyze-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .analyze-btn:hover {
            background: #0056b3;
        }

        .analyze-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .opponent-analysis {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .opponent-analysis h4 {
            margin: 0 0 10px 0;
            color: #721c24;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .recommendation-panel {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
        }

        .recommendation-panel h3 {
            margin: 0 0 15px 0;
            color: #155724;
            text-align: center;
        }

        .strategy-summary {
            background: #e2e3e5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .strategy-summary h5 {
            margin: 0 0 10px 0;
            color: #383d41;
        }

        .recommended-lineup {
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        .lineup-header {
            background: #28a745;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }

        .player-recommendation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .player-recommendation:last-child {
            border-bottom: none;
        }

        .player-recommendation:nth-child(even) {
            background: #f8f9fa;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #333;
        }

        .player-stats {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .recommendation-reason {
            font-size: 11px;
            color: #28a745;
            margin-left: 15px;
            max-width: 150px;
        }

        .matchup-chart {
            margin-top: 20px;
            text-align: center;
        }

        .matchup-comparison {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .our-team {
            color: #28a745;
            font-weight: bold;
        }

        .opponent-team {
            color: #dc3545;
            font-weight: bold;
        }

        .advantage {
            color: #28a745;
            font-size: 12px;
        }

        .disadvantage {
            color: #dc3545;
            font-size: 12px;
        }

        .neutral {
            color: #6c757d;
            font-size: 12px;
        }

        .radar-container {
            text-align: center;
            margin-top: 20px;
        }

        .radar-chart {
            margin: 0 auto;
        }

        .radar-path {
            fill: rgba(54, 162, 235, 0.2);
            stroke: rgba(54, 162, 235, 1);
            stroke-width: 2;
        }

        .radar-path.opponent {
            fill: rgba(255, 99, 132, 0.2);
            stroke: rgba(255, 99, 132, 1);
            stroke-width: 2;
        }

        .radar-axis {
            stroke: #999;
            stroke-width: 1;
        }

        .radar-grid {
            stroke: #ddd;
            stroke-width: 1;
            fill: none;
        }

        .radar-label {
            font-size: 12px;
            font-weight: bold;
            fill: #333;
            text-anchor: middle;
        }

        .legend {
            text-align: center;
            margin-top: 15px;
        }

        .legend-item {
            display: inline-block;
            margin: 0 15px;
            font-size: 14px;
        }

        .legend-line {
            display: inline-block;
            width: 20px;
            height: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .our-lineup { background-color: rgba(54, 162, 235, 1); }
        .opponent-lineup { background-color: rgba(255, 99, 132, 1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ€ NBA ìƒëŒ€ ë¼ì¸ì—… ê¸°ë°˜ ìµœì  ë¼ì¸ì—… ì¶”ì²œ</h1>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="opponent-setup">
                    <h3>ë¼ì¸ì—… ì„¤ì •</h3>
                    
                    <div class="team-selection">
                        <label>ìš°ë¦¬íŒ€ ì„ íƒ</label>
                        <select id="ourTeamSelect">
                            <option value="">íŒ€ ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div class="team-selection">
                        <label>ìƒëŒ€íŒ€ ì„ íƒ (ë¹ ë¥¸ ì„¤ì •)</label>
                        <select id="opponentTeamSelect">
                            <option value="">íŒ€ ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">ìƒëŒ€íŒ€ ë¼ì¸ì—… (5ëª… ì„ íƒ)</label>
                        <input type="text" id="playerSearch" placeholder="ì„ ìˆ˜ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 3px;">
                        <div id="playerPool" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; background: white;"></div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h5 style="margin: 0 0 10px 0; color: #856404;">ì„ íƒëœ ìƒëŒ€ ë¼ì¸ì—… (<span id="opponentCount">0</span>/5)</h5>
                        <div id="selectedOpponents" style="min-height: 50px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 5px;"></div>
                    </div>
                    
                    <button class="analyze-btn" id="analyzeBtn" onclick="analyzeMatchup()">ìƒëŒ€ ë¶„ì„ ë° ë¼ì¸ì—… ì¶”ì²œ</button>
                </div>
                
                <div class="opponent-analysis" id="opponentAnalysis" style="display: none;">
                    <h4>ğŸ” ìƒëŒ€íŒ€ ë¶„ì„</h4>
                    <div class="analysis-grid" id="opponentStats"></div>
                    <div id="opponentStrengths"></div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="recommendation-panel" id="recommendationPanel" style="display: none;">
                    <h3>ğŸ’¡ ì¶”ì²œ ë¼ì¸ì—…</h3>
                    
                    <div class="strategy-summary">
                        <h5>ì „ëµ ìš”ì•½</h5>
                        <div id="strategySummary">ìƒëŒ€íŒ€ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
                    </div>
                    
                    <div class="recommended-lineup">
                        <div class="lineup-header">ì¶”ì²œ ë¼ì¸ì—…</div>
                        <div id="recommendedPlayers"></div>
                    </div>
                    
                    <div class="matchup-chart">
                        <h5>ë§¤ì¹˜ì—… ë¹„êµ</h5>
                        <div id="matchupComparison"></div>
                    </div>
                </div>
                
                <div class="radar-container" id="radarContainer" style="display: none;">
                    <h4>ë¼ì¸ì—… ëŠ¥ë ¥ì¹˜ ë¹„êµ</h4>
                    <svg class="radar-chart" id="comparisonRadar"></svg>
                    <div class="legend">
                        <div class="legend-item">
                            <span class="legend-line our-lineup"></span>
                            ìš°ë¦¬ ì¶”ì²œ ë¼ì¸ì—…
                        </div>
                        <div class="legend-item">
                            <span class="legend-line opponent-lineup"></span>
                            ìƒëŒ€íŒ€ ë¼ì¸ì—…
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // D3.js ìŠ¤íƒ€ì¼ ì „ì—­ ì„¤ì •
        const radarSize = 350;
        const radarRadius = 120;
        const radarCenter = radarSize / 2;

        // ì „ì—­ ë³€ìˆ˜
        let allPlayers = [];
        let opponentLineup = [];
        let recommendedLineup = [];
        let ourTeamPlayers = []; // ìš°ë¦¬íŒ€ ì„ ìˆ˜í’€
        let filteredPlayers = []; // ê²€ìƒ‰ í•„í„°ë§ëœ ì„ ìˆ˜ë“¤

        // ëŠ¥ë ¥ì¹˜ ì •ì˜
        const stats = [
            { key: 'pts', label: 'ë“ì ', max: 35 },
            { key: 'ast', label: 'ì–´ì‹œìŠ¤íŠ¸', max: 12 },
            { key: 'trb', label: 'ë¦¬ë°”ìš´ë“œ', max: 15 },
            { key: 'stl', label: 'ìŠ¤í‹¸', max: 3 },
            { key: 'blk', label: 'ë¸”ë¡', max: 3 }
        ];


        // ì„ íƒì ì„¤ì •
        function setupSelectors() {
            // íŒ€ ëª©ë¡ ìƒì„±
            const teams = [...new Set(allPlayers.map(d => d.Team))].sort();
            
            // ìš°ë¦¬íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´
            const ourTeamSelect = d3.select("#ourTeamSelect");
            ourTeamSelect.selectAll("option.team-option")
                .data(teams)
                .join("option")
                .attr("class", "team-option")
                .attr("value", d => d)
                .text(d => d);
            
            // ìš°ë¦¬íŒ€ ì„ íƒ ì´ë²¤íŠ¸
            ourTeamSelect.on("change", function() {
                ourTeam = this.value;
                if (ourTeam) {
                    ourTeamPlayers = allPlayers.filter(d => d.Team === ourTeam);
                    console.log("Our team players:", ourTeamPlayers.length);
                } else {
                    ourTeamPlayers = [];
                }
                updateAnalyzeButton();
            });
            
            // ìƒëŒ€íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´
            const opponentTeamSelect = d3.select("#opponentTeamSelect");
            opponentTeamSelect.selectAll("option.team-option")
                .data(teams)
                .join("option")
                .attr("class", "team-option")
                .attr("value", d => d)
                .text(d => d);
            
            // ìƒëŒ€íŒ€ ì„ íƒ ì´ë²¤íŠ¸ (D3 ë°©ì‹ìœ¼ë¡œ ë³µì›)
            opponentTeamSelect.on("change", function() {
                const selectedTeam = this.value;
                console.log("ìƒëŒ€íŒ€ ë“œë¡­ë‹¤ìš´ ë³€ê²½:", selectedTeam);
                
                if (selectedTeam) {
                    console.log("íŒ€ì´ ì„ íƒë¨ - í•„í„°ë§ ì‹œì‘");
                    
                    // 1. ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
                    d3.select("#playerSearch").property("value", "");
                    
                    // 2. í•´ë‹¹ íŒ€ ì„ ìˆ˜ë“¤ë¡œ í•„í„°ë§
                    filteredPlayers = allPlayers.filter(d => d.Team === selectedTeam);
                    console.log("í•„í„°ë§ ì™„ë£Œ:", filteredPlayers.length, "ëª…");
                    console.log("íŒ€ ì„ ìˆ˜ë“¤:", filteredPlayers.map(p => p.Player));
                    
                    // 3. ìƒìœ„ 5ëª… ìë™ ì„ íƒ
                    const top5 = filteredPlayers
                        .sort((a, b) => b.avgMP - a.avgMP)
                        .slice(0, 5);
                    opponentLineup = [...top5];
                    console.log("ìë™ ì„ íƒëœ 5ëª…:", opponentLineup.map(p => p.Player));
                    
                    // 4. UI ì—…ë°ì´íŠ¸
                    updateSelectedOpponents();
                    renderPlayerPool();
                    updateAnalyzeButton();
                    
                } else {
                    console.log("íŒ€ ì„ íƒ í•´ì œ - ì „ì²´ í‘œì‹œ");
                    opponentLineup = [];
                    filteredPlayers = [...allPlayers];
                    updateSelectedOpponents();
                    renderPlayerPool();
                    updateAnalyzeButton();
                }
            });

            // ì´ˆê¸° ì„ ìˆ˜í’€ ì„¤ì • (D3 ë°©ì‹)
            filteredPlayers = [...allPlayers];
            renderPlayerPool();
            
            // ê²€ìƒ‰ ê¸°ëŠ¥ (D3 ë°©ì‹)
            d3.select("#playerSearch").on("input", function() {
                const searchTerm = this.value.toLowerCase();
                const selectedTeam = d3.select("#opponentTeamSelect").property("value");
                
                console.log("ê²€ìƒ‰ì–´:", searchTerm, "ì„ íƒëœ íŒ€:", selectedTeam);
                
                // ê¸°ë³¸ í•„í„°
                let baseFilter;
                if (selectedTeam) {
                    baseFilter = allPlayers.filter(d => d.Team === selectedTeam);
                } else {
                    baseFilter = [...allPlayers];
                }
                
                // ê²€ìƒ‰ì–´ í•„í„°ë§
                if (searchTerm) {
                    filteredPlayers = baseFilter.filter(player => 
                        player.Player.toLowerCase().includes(searchTerm)
                    );
                } else {
                    filteredPlayers = baseFilter;
                }
                
                renderPlayerPool();
            });
        }

        // ì„ ìˆ˜í’€ ë Œë”ë§
        function renderPlayerPool() {
            const playerPool = d3.select("#playerPool");
            
            const playerItems = playerPool.selectAll(".player-item")
                .data(filteredPlayers)
                .join("div")
                .attr("class", "player-item")
                .style("padding", "8px")
                .style("border-bottom", "1px solid #eee")
                .style("cursor", "pointer")
                .style("transition", "background 0.2s")
                .classed("selected", d => opponentLineup.some(p => p.Player === d.Player));

            playerItems.html(d => `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="position-badge pos-${d.Pos}">${d.Pos}</span>
                        <strong>${d.Player}</strong> (${d.Team})
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${d.pts}pts ${d.ast}ast ${d.trb}reb
                    </div>
                </div>
            `);

            // í´ë¦­ ì´ë²¤íŠ¸
            playerItems.on("click", function(event, d) {
                const isSelected = opponentLineup.some(p => p.Player === d.Player);
                
                if (isSelected) {
                    // ì„ íƒ í•´ì œ
                    opponentLineup = opponentLineup.filter(p => p.Player !== d.Player);
                } else {
                    // ì„ íƒ ì¶”ê°€ (ìµœëŒ€ 5ëª…)
                    if (opponentLineup.length < 5) {
                        opponentLineup.push(d);
                    } else {
                        alert("ìµœëŒ€ 5ëª…ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                }
                
                updateSelectedOpponents();
                renderPlayerPool(); // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateAnalyzeButton();
            });

            // í˜¸ë²„ íš¨ê³¼
            playerItems
                .on("mouseover", function() {
                    d3.select(this).style("background", "#f0f8ff");
                })
                .on("mouseout", function() {
                    const isSelected = d3.select(this).classed("selected");
                    d3.select(this).style("background", isSelected ? "#e3f2fd" : "white");
                });

            // ì„ íƒëœ í•­ëª© ë°°ê²½ìƒ‰
            playerItems.filter(d => opponentLineup.some(p => p.Player === d.Player))
                .style("background", "#e3f2fd");
        }

        // ì„ íƒëœ ìƒëŒ€ ë¼ì¸ì—… ì—…ë°ì´íŠ¸
        function updateSelectedOpponents() {
            d3.select("#opponentCount").text(opponentLineup.length);
            
            const selectedEl = d3.select("#selectedOpponents");
            
            if (opponentLineup.length === 0) {
                selectedEl.html('<div style="color: #666; font-style: italic;">ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>');
                return;
            }
            
            const selectedItems = selectedEl.selectAll(".selected-opponent")
                .data(opponentLineup)
                .join("div")
                .attr("class", "selected-opponent")
                .style("display", "flex")
                .style("justify-content", "space-between")
                .style("align-items", "center")
                .style("padding", "5px 0")
                .style("border-bottom", "1px solid #ffeaa7");

            selectedItems.html(d => `
                <div>
                    <span class="position-badge pos-${d.Pos}">${d.Pos}</span>
                    <strong>${d.Player}</strong> (${d.Team})
                    <span style="color: #666; font-size: 12px;"> - ${d.pts}pts ${d.ast}ast ${d.trb}reb</span>
                </div>
                <button onclick="removeOpponent('${d.Player}')" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 12px; cursor: pointer;">Ã—</button>
            `);
        }

        // ìƒëŒ€ ì„ ìˆ˜ ì œê±°
        function removeOpponent(playerName) {
            opponentLineup = opponentLineup.filter(p => p.Player !== playerName);
            updateSelectedOpponents();
            renderPlayerPool();
            updateAnalyzeButton();
        }

        // íŒ€ë³„ ë¼ì¸ì—… ìë™ ì„¤ì •
        function fillTeamLineup(teamName) {
            const teamPlayers = allPlayers.filter(d => d.Team === teamName);
            
            ['PG', 'SG', 'SF', 'PF', 'C'].forEach(position => {
                const positionPlayer = teamPlayers
                    .filter(d => d.Pos === position)
                    .sort((a, b) => b.avgMP - a.avgMP)[0]; // ì¶œì „ì‹œê°„ ê¸°ì¤€ ìµœê³  ì„ ìˆ˜
                
                if (positionPlayer) {
                    d3.select(`#opponent-${position}`)
                        .property("value", positionPlayer.Player);
                }
            });
            
            updateAnalyzeButton();
        }

        // ë¶„ì„ ë²„íŠ¼ í™œì„±í™” ì²´í¬
        function updateAnalyzeButton() {
            const analyzeBtn = d3.select("#analyzeBtn");
            
            if (!ourTeam) {
                analyzeBtn.property("disabled", true)
                    .text("ìš°ë¦¬íŒ€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”");
            } else if (opponentLineup.length !== 5) {
                analyzeBtn.property("disabled", true)
                    .text(`ìƒëŒ€ ì„ ìˆ˜ ì„ íƒ (${opponentLineup.length}/5)`);
            } else {
                analyzeBtn.property("disabled", false)
                    .text("ìƒëŒ€ ë¶„ì„ ë° ë¼ì¸ì—… ì¶”ì²œ");
            }
        }

        // ë§¤ì¹˜ì—… ë¶„ì„ ë©”ì¸ í•¨ìˆ˜
        function analyzeMatchup() {
            if (!ourTeam) {
                alert("ìš°ë¦¬íŒ€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (opponentLineup.length !== 5) {
                alert("ìƒëŒ€íŒ€ 5ëª…ì˜ ì„ ìˆ˜ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // ìƒëŒ€íŒ€ ë¶„ì„
            analyzeOpponent();
            
            // ë¼ì¸ì—… ì¶”ì²œ
            recommendLineup();
            
            // UI ì—…ë°ì´íŠ¸
            showAnalysis();
            setupComparisonRadar();
        }

        // ìƒëŒ€íŒ€ ë¶„ì„
        function analyzeOpponent() {
            const opponentStats = {
                avgPts: d3.mean(opponentLineup, d => d.pts),
                avgAst: d3.mean(opponentLineup, d => d.ast),
                avgTrb: d3.mean(opponentLineup, d => d.trb),
                avgStl: d3.mean(opponentLineup, d => d.stl),
                avgBlk: d3.mean(opponentLineup, d => d.blk),
                avgThreeP: d3.mean(opponentLineup, d => d.threeP),
                avgFG: d3.mean(opponentLineup, d => d.fieldGoal)
            };

            // ìƒëŒ€íŒ€ ë¶„ì„ UI ì—…ë°ì´íŠ¸
            const statsGrid = d3.select("#opponentStats");
            
            const statCards = [
                { label: "í‰ê·  ë“ì ", value: opponentStats.avgPts.toFixed(1) },
                { label: "í‰ê·  ì–´ì‹œìŠ¤íŠ¸", value: opponentStats.avgAst.toFixed(1) },
                { label: "í‰ê·  ë¦¬ë°”ìš´ë“œ", value: opponentStats.avgTrb.toFixed(1) },
                { label: "3ì  ì„±ê³µë¥ ", value: (opponentStats.avgThreeP * 100).toFixed(1) + "%" }
            ];

            statsGrid.selectAll(".stat-card")
                .data(statCards)
                .join("div")
                .attr("class", "stat-card")
                .html(d => `
                    <div class="stat-value">${d.value}</div>
                    <div class="stat-label">${d.label}</div>
                `);

            // ìƒëŒ€íŒ€ ê°•ì  ë¶„ì„
            const strengths = [];
            if (opponentStats.avgPts > 20) strengths.push("ê°•ë ¥í•œ ë“ì ë ¥");
            if (opponentStats.avgAst > 6) strengths.push("ë›°ì–´ë‚œ í”Œë ˆì´ë©”ì´í‚¹");
            if (opponentStats.avgTrb > 8) strengths.push("ë¦¬ë°”ìš´ë“œ ìš°ìœ„");
            if (opponentStats.avgThreeP > 0.38) strengths.push("3ì  ìŠˆíŒ… ìœ„í˜‘");
            if (opponentStats.avgBlk > 1.5) strengths.push("ë¸”ë¡ìƒ· ìˆ˜ë¹„");

            d3.select("#opponentStrengths")
                .html(`<strong>ì£¼ìš” ê°•ì :</strong> ${strengths.join(", ") || "ê· í˜•ì¡íŒ íŒ€"}`);
        }

        // ë¼ì¸ì—… ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ (í¬ì§€ì…˜ ì œì•½ ì™„ì „ ì œê±°)
        function recommendLineup() {
            console.log("=== ë¼ì¸ì—… ì¶”ì²œ ì‹œì‘ ===");
            
            const opponentStats = {
                avgPts: d3.mean(opponentLineup, d => d.pts),
                avgAst: d3.mean(opponentLineup, d => d.ast),
                avgTrb: d3.mean(opponentLineup, d => d.trb),
                avgStl: d3.mean(opponentLineup, d => d.stl),
                avgBlk: d3.mean(opponentLineup, d => d.blk),
                avgThreeP: d3.mean(opponentLineup, d => d.threeP)
            };

            console.log("ìƒëŒ€íŒ€ í‰ê·  ìŠ¤íƒ¯:", opponentStats);

            // ê° ì„ ìˆ˜ì—ê²Œ ì ìˆ˜ ë¶€ì—¬
            const scoredPlayers = ourTeamPlayers.map(player => {
                let score = 0;
                let reasons = [];

                // ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ ì ìˆ˜ (ê°€ì¤‘ì¹˜ ì ìš©)
                score += player.pts * 1.5; // ë“ì 
                score += player.ast * 2.0;  // ì–´ì‹œìŠ¤íŠ¸
                score += player.trb * 1.5;  // ë¦¬ë°”ìš´ë“œ
                score += player.stl * 3.0;  // ìŠ¤í‹¸
                score += player.blk * 3.0;  // ë¸”ë¡

                // ìƒëŒ€ë°© íŠ¹ì„±ì— ë”°ë¥¸ ì „ëµì  ë³´ë„ˆìŠ¤
                if (opponentStats.avgPts > 20) {
                    if (player.stl > 1.0) {
                        score += 15;
                        reasons.push("ìˆ˜ë¹„ë ¥");
                    }
                    if (player.blk > 1.0) {
                        score += 12;
                        reasons.push("ë¸”ë¡ìƒ·");
                    }
                }

                if (opponentStats.avgThreeP > 0.38) {
                    if (player.stl > 1.0) {
                        score += 18;
                        reasons.push("í˜ë¦¬ë¯¸í„° ìˆ˜ë¹„");
                    }
                }

                if (opponentStats.avgTrb > 8) {
                    if (player.trb > 6) {
                        score += 15;
                        reasons.push("ë¦¬ë°”ìš´ë“œ ëŒ€ì‘");
                    }
                }

                if (opponentStats.avgAst > 6) {
                    if (player.stl > 1.2) {
                        score += 12;
                        reasons.push("í”Œë ˆì´ ì°¨ë‹¨");
                    }
                }

                // ì¶œì „ì‹œê°„ ê³ ë ¤ (ì£¼ì „ê¸‰ ìš°ëŒ€)
                if (player.avgMP > 30) {
                    score += 8;
                    reasons.push("ì£¼ì „ê¸‰");
                } else if (player.avgMP > 20) {
                    score += 4;
                    reasons.push("ë¡œí…Œì´ì…˜");
                }

                // 3ì  ìŠˆíŒ… ëŠ¥ë ¥
                if (player.threeP > 0.35) {
                    score += 5;
                    reasons.push("3ì ìŠˆíŒ…");
                }

                return {
                    ...player,
                    matchupScore: score,
                    reasons: reasons
                };
            });

            // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ 5ëª… ì„ íƒ (í¬ì§€ì…˜ ì™„ì „ ë¬´ì‹œ)
            recommendedLineup = scoredPlayers
                .sort((a, b) => b.matchupScore - a.matchupScore)
                .slice(0, 5);
                
            console.log("ì¶”ì²œ ë¼ì¸ì—… (ì ìˆ˜ ê¸°ì¤€):");
            recommendedLineup.forEach((player, index) => {
                console.log(`${index + 1}. ${player.Player} (${player.Pos}) - ${player.matchupScore.toFixed(1)}ì  - ${player.reasons.join(", ")}`);
            });

            // í¬ì§€ì…˜ ë¶„í¬ í™•ì¸
            const positionCount = {};
            recommendedLineup.forEach(player => {
                positionCount[player.Pos] = (positionCount[player.Pos] || 0) + 1;
            });
            console.log("ì¶”ì²œ ë¼ì¸ì—… í¬ì§€ì…˜ ë¶„í¬:", positionCount);
            
            console.log("=== ë¼ì¸ì—… ì¶”ì²œ ì™„ë£Œ ===");
        }

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function showAnalysis() {
            // íŒ¨ë„ í‘œì‹œ
            d3.select("#opponentAnalysis").style("display", "block");
            d3.select("#recommendationPanel").style("display", "block");
            d3.select("#radarContainer").style("display", "block");

            // ì „ëµ ìš”ì•½
            const strategy = generateStrategy();
            d3.select("#strategySummary").html(strategy);

            // ì¶”ì²œ ë¼ì¸ì—… í‘œì‹œ
            const playersHtml = recommendedLineup.map(player => `
                <div class="player-recommendation">
                    <div class="player-info">
                        <div class="player-name">
                            <span class="position-badge pos-${player.Pos}">${player.Pos}</span>
                            ${player.Player}
                        </div>
                        <div class="player-stats">
                            ${player.pts}pts ${player.ast}ast ${player.trb}reb | ${player.Team}
                        </div>
                    </div>
                    <div class="recommendation-reason">
                        ${player.reasons.slice(0, 2).join(", ")}
                    </div>
                </div>
            `).join("");

            d3.select("#recommendedPlayers").html(playersHtml);

            // ë§¤ì¹˜ì—… ë¹„êµ
            showMatchupComparison();
        }

        // ì „ëµ ìƒì„±
        function generateStrategy() {
            const opponentStats = {
                avgPts: d3.mean(opponentLineup, d => d.pts),
                avgAst: d3.mean(opponentLineup, d => d.ast),
                avgTrb: d3.mean(opponentLineup, d => d.trb),
                avgThreeP: d3.mean(opponentLineup, d => d.threeP)
            };

            let strategy = "";

            if (opponentStats.avgPts > 20) {
                strategy += "â€¢ <strong>ìˆ˜ë¹„ ê°•í™”:</strong> ìƒëŒ€ì˜ ê°•í•œ ë“ì ë ¥ì— ëŒ€ì‘í•˜ì—¬ ìˆ˜ë¹„í˜• ì„ ìˆ˜ë“¤ë¡œ êµ¬ì„±<br>";
            }

            if (opponentStats.avgThreeP > 0.38) {
                strategy += "â€¢ <strong>í˜ë¦¬ë¯¸í„° ìˆ˜ë¹„:</strong> 3ì  ìŠˆíŒ…ì„ ì°¨ë‹¨í•  ìˆ˜ ìˆëŠ” ì™¸ê³½ ìˆ˜ë¹„ìˆ˜ ë°°ì¹˜<br>";
            }

            if (opponentStats.avgTrb > 8) {
                strategy += "â€¢ <strong>ë¦¬ë°”ìš´ë“œ ê²½ìŸ:</strong> ë¦¬ë°”ìš´ë“œ ìš°ìœ„ë¥¼ ìœ„í•œ ì¥ì‹  ì„ ìˆ˜ë“¤ íˆ¬ì…<br>";
            }

            if (opponentStats.avgAst > 6) {
                strategy += "â€¢ <strong>í”Œë ˆì´ ì°¨ë‹¨:</strong> ìƒëŒ€ í”Œë ˆì´ë©”ì´í‚¹ì„ ë°©í•´í•  ìˆ˜ ìˆëŠ” ìŠ¤í‹¸ ì „ë¬¸ê°€ í™œìš©<br>";
            }

            return strategy || "â€¢ <strong>ê· í˜• ë¼ì¸ì—…:</strong> ìƒëŒ€íŒ€ì— íŠ¹ë³„í•œ ì•½ì ì´ ì—†ì–´ ë°¸ëŸ°ìŠ¤ ì¡íŒ êµ¬ì„±ìœ¼ë¡œ ëŒ€ì‘";
        }

        // ë§¤ì¹˜ì—… ë¹„êµ í‘œì‹œ
        function showMatchupComparison() {
            const ourStats = {
                pts: d3.mean(recommendedLineup, d => d.pts),
                ast: d3.mean(recommendedLineup, d => d.ast),
                trb: d3.mean(recommendedLineup, d => d.trb),
                stl: d3.mean(recommendedLineup, d => d.stl),
                blk: d3.mean(recommendedLineup, d => d.blk)
            };

            const opponentStats = {
                pts: d3.mean(opponentLineup, d => d.pts),
                ast: d3.mean(opponentLineup, d => d.ast),
                trb: d3.mean(opponentLineup, d => d.trb),
                stl: d3.mean(opponentLineup, d => d.stl),
                blk: d3.mean(opponentLineup, d => d.blk)
            };

            const comparisons = [
                { stat: "ë“ì ", our: ourStats.pts, opponent: opponentStats.pts },
                { stat: "ì–´ì‹œìŠ¤íŠ¸", our: ourStats.ast, opponent: opponentStats.ast },
                { stat: "ë¦¬ë°”ìš´ë“œ", our: ourStats.trb, opponent: opponentStats.trb },
                { stat: "ìŠ¤í‹¸", our: ourStats.stl, opponent: opponentStats.stl },
                { stat: "ë¸”ë¡", our: ourStats.blk, opponent: opponentStats.blk }
            ];

            const comparisonHtml = comparisons.map(comp => {
                const diff = comp.our - comp.opponent;
                const advantage = Math.abs(diff) < 0.5 ? "neutral" : (diff > 0 ? "advantage" : "disadvantage");
                const symbol = advantage === "advantage" ? "â†‘" : (advantage === "disadvantage" ? "â†“" : "=");

                return `
                    <div class="matchup-comparison">
                        <span class="our-team">${comp.our.toFixed(1)}</span>
                        <span class="${advantage}">${comp.stat} ${symbol}</span>
                        <span class="opponent-team">${comp.opponent.toFixed(1)}</span>
                    </div>
                `;
            }).join("");

            d3.select("#matchupComparison").html(comparisonHtml);
        }

        // ë¹„êµ ë ˆì´ë” ì°¨íŠ¸ ì„¤ì •
        function setupComparisonRadar() {
            const svg = d3.select("#comparisonRadar")
                .attr("width", radarSize)
                .attr("height", radarSize);

            // ê¸°ì¡´ ì°¨íŠ¸ ì§€ìš°ê¸°
            svg.selectAll("*").remove();

            const chartGroup = svg.append("g")
                .attr("transform", `translate(${radarCenter}, ${radarCenter})`);

            // ê·¸ë¦¬ë“œ ì› ê·¸ë¦¬ê¸°
            const gridLevels = 5;
            for (let i = 1; i <= gridLevels; i++) {
                chartGroup.append("circle")
                    .attr("class", "radar-grid")
                    .attr("r", (radarRadius / gridLevels) * i);
            }

            // ì¶• ê·¸ë¦¬ê¸°
            const angleSlice = (Math.PI * 2) / stats.length;
            
            stats.forEach((stat, i) => {
                const angle = angleSlice * i - Math.PI / 2;
                const x = Math.cos(angle) * radarRadius;
                const y = Math.sin(angle) * radarRadius;
                
                // ì¶•ì„ 
                chartGroup.append("line")
                    .attr("class", "radar-axis")
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", x)
                    .attr("y2", y);
                
                // ë ˆì´ë¸”
                const labelX = Math.cos(angle) * (radarRadius + 25);
                const labelY = Math.sin(angle) * (radarRadius + 25);
                
                chartGroup.append("text")
                    .attr("class", "radar-label")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .attr("dy", "0.35em")
                    .text(stat.label);
            });

            // ë°ì´í„° íŒ¨ìŠ¤ ìƒì„±
            function createRadarPath(players, className) {
                const values = {
                    pts: d3.mean(players, d => d.pts),
                    ast: d3.mean(players, d => d.ast),
                    trb: d3.mean(players, d => d.trb),
                    stl: d3.mean(players, d => d.stl),
                    blk: d3.mean(players, d => d.blk)
                };

                let pathData = "";
                stats.forEach((stat, i) => {
                    const angle = angleSlice * i - Math.PI / 2;
                    const value = Math.min(values[stat.key], stat.max);
                    const radius = (value / stat.max) * radarRadius;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    if (i === 0) {
                        pathData += `M ${x} ${y}`;
                    } else {
                        pathData += ` L ${x} ${y}`;
                    }
                });
                pathData += " Z";

                chartGroup.append("path")
                    .attr("class", `radar-path ${className}`)
                    .attr("d", pathData)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1);
            }

            // ìƒëŒ€íŒ€ ë¼ì¸ì—…
            createRadarPath(opponentLineup, "opponent");
            
            // ìš°ë¦¬íŒ€ ì¶”ì²œ ë¼ì¸ì—…
            createRadarPath(recommendedLineup, "");
        }

        // ì „ì—­ í•¨ìˆ˜
        window.analyzeMatchup = analyzeMatchup;
        window.removeOpponent = removeOpponent;

        // ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
        loadData();

        function loadData() {
            // D3 CSV ë¡œë“œ ëŒ€ì‹  ì§ì ‘ ë°ì´í„° ì‚¬ìš©
            const data = window.nba_data; // nba_24_25.jsì—ì„œ ë¡œë“œëœ ë°ì´í„°
            rawData = data.map(d => ({
                ...d,
                PTS: +d.PTS,
                G: +d.G,
                AST: +d.AST,
                TRB: +d.TRB,
                STL: +d.STL,
                BLK: +d.BLK,
                MP: +d.MP,
                threeP: +d['3P%'],
                freeThrow: +d['FT%'],
                fieldGoal: +d['FG%'],
                // ê²½ê¸°ë‹¹ í‰ê·  ê³„ì‚°
                pts: +(d.PTS / d.G).toFixed(1),
                ast: +(d.AST / d.G).toFixed(1),
                trb: +(d.TRB / d.G).toFixed(1),
                stl: +(d.STL / d.G).toFixed(1),
                blk: +(d.BLK / d.G).toFixed(1),
                avgMP: +(d.MP / d.G).toFixed(1)
            })).filter(d => d.Pos && d.PTS > 0 && d.G > 20);

            // ìš°ë¦¬íŒ€ ì„ ìˆ˜ë“¤ í•„í„°ë§ (ì´ˆê¸°ì—ëŠ” ë¹„ì–´ìˆìŒ)
            ourTeamPlayers = [];
            
            console.log("Loaded players:", allPlayers.length);
            
            setupSelectors();

        }
    </script>
</body>
</html>